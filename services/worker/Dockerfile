# services/worker/Dockerfile

# Build L-SMASH and m4acut
FROM amazonlinux:2 AS build

ENV INSTALL_ROOT=/opt/m4acut

RUN yum update -y && \
    yum install -y git gcc gcc-c++ make autoconf automake libtool pkgconfig yasm which && \
    yum clean all && rm -rf /var/cache/yum

WORKDIR /build

# Build L-SMASH (dependency of m4acut)
ARG LSMASH_VERSION=v2.14.5
RUN git clone --depth 1 --branch ${LSMASH_VERSION} https://github.com/l-smash/l-smash.git && \
    cd l-smash && \
    ./configure --prefix=/usr/local && \
    make -j"$(nproc)" && \
    make install && \
    make install DESTDIR=${INSTALL_ROOT}

# Build m4acut following upstream instructions
RUN git clone https://github.com/nu774/m4acut.git && \
    cd m4acut && \
    autoreconf -i && \
    ./configure --prefix=/usr/local && \
    make -j"$(nproc)" && \
    make install && \
    make install DESTDIR=${INSTALL_ROOT}

# Lambda runtime with Node
FROM public.ecr.aws/lambda/nodejs:22

# Copy m4acut
COPY --from=build /opt/m4acut /opt/m4acut
ENV PATH="/opt/m4acut/usr/local/bin:${PATH}"

# Copy worker bundle generated by `pnpm -F @mixcut/worker build`
COPY dist/index.js ${LAMBDA_TASK_ROOT}

CMD [ "index.handler" ]
